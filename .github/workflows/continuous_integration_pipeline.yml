name: CI

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'                 # triggers on v1.2.3, v1.2.3-rc1, etc.
  release:
    types: [published]
  workflow_dispatch: {}       # optional: let you run it manually


env:
  PIP_DISABLE_PIP_VERSION_CHECK: '1'
  PYTHONUNBUFFERED: '1'
  DEPLOY_PAGES: '0' # set to '1' to enable docs deploy

permissions:
  contents: read
  packages: write

jobs:
  build:
    name: Build ${{ matrix.pkg.name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        pkg:
          - { name: lexical-graph,           path: lexical-graph,                        dist: lexical-graph/dist/final }
          - { name: control-plane,           path: control-plane,                        dist: control-plane/dist/final }
          - { name: data-plane,              path: data-plane,                           dist: data-plane/dist/final }
          - { name: document-graph,          path: document-graph,                       dist: document-graph/dist/final }
          - { name: inventory-graph,         path: inventory-graph,                      dist: inventory-graph/dist/final }
          - { name: evidence-graph,          path: evidence-graph,                       dist: evidence-graph/dist/final }
          - { name: support-graph,           path: support-graph,                        dist: support-graph/dist/final }
          - { name: byokg-rag,               path: byokg-rag,                            dist: byokg-rag/dist/final }
          - { name: ucbl-logger,             path: ucbl-logger-main,                     dist: ucbl-logger-main/dist/final }
          - { name: falkor-contrib,          path: lexical-graph-contrib/falkordb,       dist: lexical-graph-contrib/dist/final }
          - { name: lg-notebooks,            path: examples/lexical-graph-notebooks,     dist: examples/dist/final }
          - { name: lg-hybrid-notebooks,     path: examples/lexical-graph-hybrid-notebooks, dist: examples/dist/final }
          - { name: dg-cloud-notebooks,      path: examples/document-graph-cloud-notebooks, dist: examples/dist/final }
          - { name: wiz-use-case-notebooks,  path: examples/wiz-use-case-notebooks,      dist: examples/dist/final }
          - { name: control-plane-notebooks, path: examples/control-plane-notebooks,     dist: examples/dist/final }
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Prepare tags for SCM versioning
        run: git fetch --tags --force
      - run: pip install hatch hatch-vcs hatch-requirements-txt
      - name: Copy repo .git for SCM versioning
        run: |
          rm -rf "${{ matrix.pkg.path }}/.git"
          cp -a .git "${{ matrix.pkg.path }}"
      - name: Build wheel with hatch
        working-directory: ${{ matrix.pkg.path }}
        run: |
          git tag -l
          rm -rf dist/
          hatch build -t wheel
      - name: Collect wheels
        run: |
          mkdir -p "${{ matrix.pkg.dist }}"
          mv -f "${{ matrix.pkg.path }}/dist/"*.whl "${{ matrix.pkg.dist }}/" || true
          unzip -l "${{ matrix.pkg.dist }}/"*.whl || echo "No wheel found"
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.pkg.name }}-dist
          path: ${{ matrix.pkg.dist }}


  publish:
    name: Publish per-package releases (PRIVATE)
    runs-on: ubuntu-latest
    needs: [ build ]
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        pkg:
          - { name: control-plane,   dist: control-plane/dist/final }
          - { name: data-plane,      dist: data-plane/dist/final }
          - { name: lexical-graph,   dist: lexical-graph/dist/final }
          - { name: falkor-contrib,  dist: lexical-graph-contrib/dist/final }
          - { name: document-graph,  dist: document-graph/dist/final }
          - { name: inventory-graph, dist: inventory-graph/dist/final }
          - { name: evidence-graph,  dist: evidence-graph/dist/final }
          - { name: support-graph,   dist: support-graph/dist/final }
          - { name: byokg-rag,       dist: byokg-rag/dist/final }
          - { name: ucbl-logger,     dist: ucbl-logger-main/dist/final }
          - { name: lg-notebooks,    dist: examples/dist/final }
          - { name: lg-hybrid-notebooks, dist: examples/dist/final }
          - { name: dg-cloud-notebooks,  dist: examples/dist/final }
          - { name: wiz-use-case-notebooks, dist: examples/dist/final }
          - { name: control-plane-notebooks, dist: examples/dist/final }
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.pkg.name }}-dist
          path: ${{ matrix.pkg.dist }}

      # compute a unique tag per package, e.g. v1.2.7-lexical-graph
      - name: Compute per-package tag
        run: |
          base="${GITHUB_REF_NAME:-}"
          if [ -z "$base" ]; then base="${{ github.event.release.tag_name }}"; fi
          echo "PKG_TAG=${base}-${{ matrix.pkg.name }}" >> "$GITHUB_ENV"

      # create the per-package release once (safe if it already exists)
      - name: Create per-package release (idempotent)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release view "$PKG_TAG" --repo "$GITHUB_REPOSITORY" >/dev/null 2>&1 || \
          gh release create "$PKG_TAG" \
            --repo "$GITHUB_REPOSITORY" \
            --title "$PKG_TAG" \
            --target "$GITHUB_SHA" \
            --generate-notes

      # upload this package's wheel(s) to its own release
      - name: Upload wheel to per-package release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          shopt -s nullglob
          files=("${{ matrix.pkg.dist }}"/*.whl)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No wheels found in ${{ matrix.pkg.dist }} (skipping)"; exit 0; fi
          gh release upload "$PKG_TAG" "${files[@]}" --repo "$GITHUB_REPOSITORY" --clobber
  
  
  

  docs:
    name: Build docs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        if: ${{ github.ref == 'refs/heads/main' && env.DEPLOY_PAGES == '1' }}
      - uses: actions/setup-python@v5
        if: ${{ github.ref == 'refs/heads/main' && env.DEPLOY_PAGES == '1' }}
        with:
          python-version: '3.12'
      - run: pip install -r sphinx-docs/requirements-docs.txt
        if: ${{ github.ref == 'refs/heads/main' && env.DEPLOY_PAGES == '1' }}
      - run: chmod +x build_sphinx_docs.sh
        if: ${{ github.ref == 'refs/heads/main' && env.DEPLOY_PAGES == '1' }}
      - run: ./build_sphinx_docs.sh --pagescs/* sphinx-docs/source/infrastructure/ || echo "Failed to copy to sphinx source"
        if: ${{ github.ref == 'refs/heads/main' && env.DEPLOY_PAGES == '1' }}
      - run: |
          cd sphinx-docs
          make html
          cd ..
          mkdir -p public
          cp -r sphinx-docs/build/html/* public/
        if: ${{ github.ref == 'refs/heads/main' && env.DEPLOY_PAGES == '1' }}
      - uses: actions/upload-pages-artifact@v3
        if: ${{ github.ref == 'refs/heads/main' && env.DEPLOY_PAGES == '1' }}
        with:
          path: public

  deploy-pages:
    needs: docs
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - id: deployment
        if: ${{ github.ref == 'refs/heads/main' && env.DEPLOY_PAGES == '1' }}
        uses: actions/deploy-pages@v4